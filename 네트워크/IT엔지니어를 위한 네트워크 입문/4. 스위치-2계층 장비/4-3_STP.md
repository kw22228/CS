### STP

- SPoF (Single Point of Failure)
  - 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소.
  - 이러한 것을 막기위해 이중화, 다중화된 네트워크를 디자인하고 구성한다. (2대 이상의 스위치를 사용함.)
    하지만, 이렇게 2개 이상의 스위치를 사용하면 스위치되고 스위치되고 하는 "네트워크 루프"에 걸릴 수 있음.

#### 루프란?

- 말 그대로 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황. (네트워크가 마비되고 통신이 안되는 상황이 발생함.)
- 루프가 발생하는 이유
  1. 브로드캐스트 스톰
     - 루프문제의 대부분을 차지한다.
     - 처음 단말에서 브로드캐스트를 발생시키면 스위치는 패킷을 보낸 포트를 제외한 모든 포트로 플러딩한다.
       근데 이 플러딩된 패킷이 또 다른스위치로 보내지면 그 스위치에서 또 브로드캐스트를 발생시킨다. (루프)
     - 브로드캐스트 스톰이 일어나면 생기는 일
       - 네트워크에 접속된 단말의 속도가 느려진다. (많은 브로드캐스트를 처리해야 하므로 CPU사용률이 높아진다.)
       - 네트워크 접속 속도가 느려진다. (거의 통신이 불가능한 수준이 된다.)
       - 네트워크에 설치된 스위치에 모든 LED들이 동시에 빠른 속도로 깜빡인다.
  2. 스위치 MAC 러닝 중복 문제
     - 스위치는 출발지 MAC주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷간의 포트가 달라 정상적으로 학습하지 못하는 문제이다.
     - 스위치 MAC주소 테이블은 하나의 MAC주소에 하나의 포트만 학습할 수 있는데 동일한 MAC 주소가 여러포트에서 학습되면 MAC테이블이 반복적으로 갱신되어 정상적으로 동작하지 않는다. (MAC 어드레스 플래핑)

#### STP 란?

- 스패닝 트리 프로토콜 (Spanning Tree Protocol) 은 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘이다.
  (루프가 돌지 않게 하기 위해 한쪽 포트를 차단했다가 장애가 발생하면 장애포트를 차단하고 원래 차단되었던 포트를 복구한다.)
- 스패닝 트리 프로토콜을 이용해 루프를 예방하기 위해서는 스위치가 어떻게 연결되었는지 알아야한다.
  그래서 전체적인 스위치 연결을 파악하기 위해 BPDU (Bridge Protocol Data Unit)이라는 프로토콜을 통해 스위치간에 정보를 전달하고 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인한다.

- 스위치 포트의 상태 및 변경 과정

  - 스패닝 트리 프로토콜이 동작중인 스위치에서는 루프를 막기 위해 스위치 포트에 신규 스위치가 연결되면 트래픽이 흐르지 않게 차단한다.
    그리고나서 해당 포트로 트래픽이 돌아도되는지 확인하기 위해서 BPDU를 학습하고 구조를 파악한 뒤 트래픽을 흘리거나, 루프 구조인경우 차단 상태를 유지한다.
  - 차단 상태에서 트래픽이 흐를때까지 스위치 포트의 상태
    1. Blocking
       - 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다린다.
       - 총 20초인 Max Age 기간 동안 상대방 스위치에서 BPDU를 받지 못했거나 후순위 BPDU를 받았을 때 포트는 리스닝 상태로 변한다.
       - BPDU 기본 교환 주기는 2초이고 10번의 BPDU를 기다린다.
    2. Listening
       - 리스닝 상태는 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계이다.(이 상태부터는 자신의 BPDU정보를 상대방에게 전송하기 시작)
       - 총 15초 동안 대기한다.
    3. Learning
       - 러닝 상태는 이미 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC주소를 러닝하는 단계이다.
       - 총 15초 동안 대기한다.
    4. Forwarding
       - 패킷을 포워딩하는 단계이다. 정상적으로 통신이 가능.

- STP 동작 방식

  1. 하나의 루트 스위치를 선정한다.
     A. 전체 네트워크에 하나의 루트 스위치를 선정한다.
     B. 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달한다.
  2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정한다.
     A. 루트 브릿지로 가는, 경로가 가장 짧은 포트를 "루트 포트" 라고 한다.
     B. 루트 브릿지에서 보낸 BPDU를 받는 포트다.
  3. 하나의 세그먼트에 하나의 지정포트를 선정한다.
     A. 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정한다.
     B. 스위치 간의 연결해서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 된다.
     C. 스위치 간의 연결해서 아무도 루트 포트가 아닐 경우, 한쪽은 지정 포트로 선정되고 다른 한쪽은 대체 포트가 되어 차단 상태가 됩니다.
     D. BPDU가 전달되는 포트다.

- 향상된 STP(RSTP, MST)
  - RSTP
    - STP는 이중화된 스위치 경로 중 정상적인 경로에 문제가 발생할 경우, 백업 경로를 활성화하는데 30 ~ 50초가 소요된다.
      이렇게 활성화 하는데 오래걸리는 문제를 해결하기 위해 RSTP (Rapid Spanning Tree Protocol)이 개발되었다.
    - RSTP는 2~3초로 절체 시간이 짧아 TCP 기반 어플리케이션이 세션을 유지할 수 있다.
  - MST
