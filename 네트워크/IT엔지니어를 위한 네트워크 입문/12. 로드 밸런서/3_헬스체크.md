### 헬스 체크

- 로드밸런서는 부하 분산을 하는 각 서버의 서비스를 주기적으로 헬스 체크하여 정상적인 서비스 쪽으로만 부하를 분산하고
  비정상적인 서버는 서비스 그룹에서 제외해 트래픽을 보내지 않는다.

#### 헬스 체크 방식

1. ICMP

   - 단순히 서버가 살아 있는지 여부만 체크하는 방법

2. TCP 서비스 포트

   - 로드 밸런서에 설정된 서버의 서비스 포트를 확인하는 것이다.
     즉, 로드 밸런서에 서버의 서비스 포트 2000번 등록하면 리얼IP의 2000번 포트로 SYN을 보내고 해당 리얼IP를 가진 서버로부터
     SYN, ACK를 받으면 서버에 다시 ACK로 응답하고 FIN을 보내 헬스체크를 종료한다.

3. TCP 서비스 포트: Half Open

   - 3방향 핸드셰이크와 동일하게 SYN을 보내고 SYN, ACK를 받지만 이후 ACK대신 RST를 보내고 세션을 끊는다.

4. HTTP 상태 코드
   - 로드 밸런서가 3방향 핸드셰이크를 거치고나서 HTTP를 요청해 정상적인 상태코드(200)을 응답하는지 여부를 체크해 헬스체크를 수행

#### 헬스 체크 주기와 타이머

- 헬스 체크의 주요 고려사항인 헬스 체크 주기가 있다.
- 주요 타이머 값.
  - 주기(Interval)
    - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
  - 응답 시간(Response)
    - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내고 응답을 기다리는 시간
    - 응답이 오지 않으면 실패로 간주
  - 시도 횟수(Retires)
    - 로드 밸런서에서 헬스 체크 실패시 최대 시도 횟수
    - 최대 시도 횟수 이전에 성공 시 시도 횟수는 초기화 된다.
  - 타임아웃 (Timeout)
    - 로드 밸런서에서 헬스 체크 실패 시 최대 대기 시간
    - 헬스 체크 패킷을 서버로 전송한 후 이시간내에 성공하지 못하면 해당 서버는 다운
  - 서비스 다운 시의 주기(Dead Interval)
    - 서비스의 기본적인 헬스 체크 주기가 아닌, 서비스 다운 시의 헬스 체크 주기
    - 서비스가 죽은 상태에서 헬스 체크 주기를 별도로 더 늘릴 때 사용
