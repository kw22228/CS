### TCP와 UDP

- 4계층에서는 목적지 프로세스를 정확히 찾아가고 패킷 순서가 바뀌거나 유실 되지 않도록 원래 데이터를 잘 만들어내기 위한 역할을 한다.
  이러한 4계층에서 동작하는 TCP/IP 프로토콜 스택에 대해 알아보자

#### 4계층 프로토콜(TCP, UDP)과 서비스 포트

- 4계층에서의 인캡슐레이션 할때 헤더에 추가되는 중요한 정보

  - 각 계층에서 정의하는 정보
  - 상위 프로토콜 지시자 정보 (2계층은 이더타입, 3계층은 프로토콜 번호, 4계층은 포트번호)

- 포트 번호.
  - 웰 노운 포트
    - HTTP TCP 80, HTTPS TCP 443, SMTP TCP 25같이 잘 알려진 포트
    - 이 포트들은 이미 인터넷 주소 할당기구인 IANA에 등록되고 1023번 이하의 포트 번호를 사용한다.

#### TCP

- TCP 프로토콜은 신뢰할 수 없는 공용망에서도 정보 유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고
  데이터를 분할하고 분할된 패킷이 잘 전송되었는지 확인하는 기능이 있다.
- 패킷에 번호(시퀀스 넘버)를 부여하고 잘 전송되었는지에 대해 응답(Ack 번호)한다.

- 윈도 사이즈와 슬라이딩 윈도우

  - 윈도 사이즈란?
    - TCP는 일반적으로 패킷을 보내는게아니라 seq를 보내고 ack를 받고(주고받고)를 한다.
      때문에, 송신자와 수신자와의 거리가 멀면 왕복 지연시간이 늘어나므로 응답이 길어진다.
      그래서 패킷을 한꺼번에 보내고 하나의 응답을 받는데 이 데이터를 받는 크기에 따라 유실 될 수도 있다.
      이때 이 데이터를 받을수 있는 크기를 "윈도 사이즈" 라고 한다.
  - 슬라이딩 윈도란?
    - 위의 윈도 사이즈를 조절하는 것을 "슬라이딩 윈도" 라고 한다.

- 3방향 핸드셰이크
  - 통신을 할때 목적지가 데이터를 받을 준비가 안된 상황에서 데이터를 일방적으로 전송하면 목적지는 데이터를 받을수 없어 버려진다.
  - TCP 프로토콜은 이런상황을 만들지 않기 위해서 통신 전, 데이터를 안전하게 보내고 받을 수 있는지 미리 확인한다.
    TCP 에서는 3번의 패킷을 주고받으면서 통신을 서로 준비하는데 이것을 "3방향 핸드셰이크" 라고 부른다
  - 진행 사항
    1. 서버에서는 서비스를 제공하기 위해 클라이언트의 접속을 받아들일 수 있는 LISTEN 상태로 대기한다.
    2. 클라이언트에서 통신을 시도할 때 Syn 패킷을 보내는데 클라이언트에서는 이상태를 SYN-SENT라고 한다.
    3. 클라이언트의 Syn을 받은 서버는 SYN-REVEIVE 상태로 변경되고 Syn, Ack로 응답한다.
    4. 이 응답을 받은 클라이언트는 ESTABLISHED 상태로 변경하고 그에 대한 응답을 서버로 보낸다.
    5. 서버에서도 이 응답을 받고 ESTABLISHED 상태로 변경된다.
       (ESTABLISHED 상태는 서버와 클라이언트 간의 연결이 성공적이라는 뜻.)
  - 플래그
    - 이러한 3방향 핸드셰이크 과정이 생기다보니 기존 통신과 새로운 통신을 구분해야하는데 이것을 플래그로 구분한다.
    - 종류
      - SYN
        - 연결 시작 용도로 사용한다. 연결이 시작될 때 SYN플래그에 1로 표시해 보낸다.
      - ACK
        - ACK 번호가 유효할 경우, 1로 표시해 보낸다.
        - 초기 SYN이 아닌 모든 패킷은 기본 메세지에 대한 응답이므로 ACK플래그가 1로 표기된다.
      - FIN
        - 연결 종료 시 1로 표시된다. 데이터 전송을 마친 후 정상적으로 양방향 종료 시 사용된다.
      - RST
        - 연결 종료 시 1로 표시된다. 연결 강제 종료를 위해 연결을 일방적으로 끊을 때 사용된다.
      - URG
        - 긴급 데이터인 경우 1로 표시한다.
      - PSH
        - 서버 측에서 전송할 데이터가 없거나 데이터를 버퍼링 없이 응용 프로그램으로 즉시 전달할 것을 지시 할때,

#### UDP

- 음성 데이터나 실시간 스트리밍과 같이 시간에 민감한 프로토콜이나 어플리케이션을 사용하는 경우나
  사내 방송이나 증권 시세 데이터 전송에 사용되는 멀티캐시트처럼 단방향으로 다수의 단말과 통신해 응답을 받기 어려운 환경에서 주로 사용된다.
  (즉, 신뢰성보다 일부 데이터가 유실되더라도 시간에 맞추어 계속 전송하는 것이 중요한 서비스인경우 UDP사용.)

| TCP                            | UDP                                |
| ------------------------------ | ---------------------------------- |
| 연결 지향(Connection Oriented) | 비연결형(Connectionless)           |
| 오류 제어 수행함               | 오류 제어 수행 안 함               |
| 흐름 제어 수행함               | 흐름 제어 수행 안 함               |
| 유니캐스트                     | 유니캐스트,멀티캐스트,브로드캐스트 |
| 전이중(Full Duplex)            | 반이중(Half Duplex)                |
| 데이터 전송                    | 실시간 트래픽 전송                 |
