### 4계층 장비를 통과할 때의 유의점 (세션관리)

- 세션 장비는 일반적인 2, 3 계층 장비와는 다르게 세션을 이해하고 세션 테이블을 유지한다.
  세션 테이블 정보를 이용해 패킷을 변경하거나 어플리케이션 성능을 최적화하고 보안을 강화하기 위해 패킷을 포워딩 하거나 드롭할 수 있다.

#### 세션 테이블 유지, 세션 정보 동기화

- 종단 장비에서 통신을 시작하면 중간에 있는 세션장비는 해당 세션 상태를 테이블에 기록한다.
- 통신이 없더라도 종단 장비간 통신이 정상적으로 종료되지 않았다면 일정 시간 동안 세션테이블을 유지한다.
- 이 유지되는 세션 테이블은 메모리에 저장되므로 메모리 사용률을 적절하게 사용하기위해 일정 시간만 세션을 유지한다.
  또한, 악의적으로 세션을 과도하게 발생시켜 세션테이블 생성을 방해하는 세션공격으로부터 보호하기위해 세션 타입아웃값을 더 줄이기도 한다.
- 세션 장비의 세션만료 시간이 어플리케이션 세션 만료 시간보다 짧을경우 생기는 문제

  - 장비의 세션이 만료되었는데 어플리케이션 세션은 유지되고 있을다면 세션 장비의 세션테이블이 없는 상황에 SYN이 아닌 ACK로 표시된 패킷이 들어오면
    세션 장비는 비정상 통신으로 판단되어 패킷을 차단한다.
  - 동작 순서
    1. 3방향 핸드셰이크를 통해 정상적으로 세션 설정
       - 방화벽에서 세션 설정 과정을 확인후 세션 테이블 기록.
    2. 세션 장비와 어플리케이션의 세션 테이블을 참조해 방화벽에서 패킷 통과
    3. 일정 시간 통신 없음
    4. 세션 타임아웃으로 세션 테이블 만료
    5. 세션 만료후 어플리케이션 통신 시작
    6. 세션이 만료되어 방화벽에서 패킷 드롭.

- 위의 세션 동기화 문제를 해결하는 방법
  1. 세션 만료 시간 증가
     - 세션 장비를 어플리케이션에 맞게 만료 시간을 늘린다. (어플리케이션 보다 장비의 유지 시간이 더 길어야 함.)
     - 어플리케이션 세션 유지 시간을 세션 장비 운영자에게 미리 알려줘야 한다.
  2. 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정
     - 세션 테이블에 정보가 없는 ACK패킷이 들어오면 패킷을 차단하지만 방화벽 옵션을 조정해
       세션 테이블에 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과시킬 수 있다.
     - 세션을 차단하지는 않지만 보안이 취약해짐. (비추천)
  3. 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
     - 세션 장비에서 세션이 타임아웃되면 세션 정보를 삭제하는게 아니라 세션 정보에 있는 양 종단 장비에 세션 정보 만료를 통보한다.
       TCP의 RST 플래그를 1로 세팅해 양 종단 장비에 전송하면 양 종단 장비는 세션이 비정상적으로 종료된 것으로 판단해 세션을 끊는다.
     - 이후에 어플리케이션이 통신하면 새로운 세션을 맺어 통신한다.
     - 동작 순서
       1. 세션 설정
       2. 일정 시간동안 통신 없음
       3. 세션 타임아웃되어 만료
       4. 방화벽에서 양 종단 장비에 RST 패킷 전송
       5. RST 패킷을 받은 양 종단 장비는 프로세스를 종료
  4. 어플리케이션에서 주기적인 패킷 발생 기능 추가(개발자 입장)
     - 어플리케이션 개발 시 중간에 통신이 없더라도 일정 시간마다 양 단말의 세션 정보를 체키하는 더미 패킷을 보내면
       패킷이 주기적으로 발생해 세션을 계속 유지할 수 있다. (가장 추천하는 방법)

#### 비대칭 경로 문제

- 네트워크의 안정성을 보장하기위해 네트워크 회선과 장비를 이중화한다. 이때 패킷이 지나가는 경로가 2개 이상이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다를수 있다.
  인바운드 패킷과 아웃바운드 패킷의 경로가 같은 장비를 통과하면 "대칭 경로" 라고하고 다르면 "비대칭 경로" 라고한다.
- 어떤 문제가 일어날까?
  - 인바운드 패킷과 아웃바운드 패킷의 경로가 다르면, 서로 통과하는 방화벽 장비가 다르기 때문에 세션 테이블에 정보가 없다.
    따라서, 패킷이 차단되어 통신이 되지 않는다.
- 해결 방법
  1. 세션 테이블을 동기화 한다. (비추천)
     - 세션 테이블을 동기화 해버리면 서로다른 경로의 장비를 통과하더라도 세션테이블에 정보가 있기때문에 패킷을 정상적으로 전송할 수 있다.
     - 하지만 세션을 동기화하는 시간보다 패킷 응답(아웃 바운드)가 더 빨라버리면 패킷이 차단될 수 있다.
  2. 비대칭 경로가 생길 경우 다양한 방법으로 이 경로를 보정하는 방법.
     - 인바운드 패킷이 통과하지않은 방화벽을 아웃바운드 패킷이 통과하게 되면 인바운드 패킷이 통과한 다른 방화벽으로 패킷을 보내 경로를 보정한다. (강제로 대칭경로를 만들어줌)
     - 강제로 다른 방화벽으로 패킷을 보내기 위해 방화벽간 통신용 링크가 필요하고, MAC주소를 변경하는 MAC 리라이팅이나 패킷에 MAC주소를 한번더 인캡슐레이션하는 터널링 기법으로 경로를 보정한다.

#### 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항

- 대부분의 통신은 하나의 통신에 한개의 세션만 이용하지만 특별한 목적으로 두개 이상의 세션을 만드는 경우가 있다.
  두 통신중 한쪽 세션이 끊겨 있거나 세션 장비의 세션테이블이 삭제되면 통신하지 못할 수 있다.
