### NAT / PAT

- NAT란?

  - 네트워크 주소를 변환하는 기술이다.
  - 1:1 변환 뿐만아니라 여러개의 IP를 하나의 IP로 변환할 수 도 있다. (회사에서 여러대의 컴퓨터가 하나의 IP주소로 인터넷에 접속하는 것)
  - 사설IP에서 공인IP, 공인IP에서 사설IP, 사설IP주소에서 또 다른 사설IP, 공인IP에서 또 다른 공인IP로도 변환가능.

- PAT란?
  - NAT는 IP주소만 변환하지만, PAT는 IP주소와 포트 번호를 변환한다. (NAT는 여러 사설IP가 공인IP로 변환은되지만 포트번호까지 변환은 안됨.)
  - IP주소는 공인IP로 같지만, 사용자 개개인의 고유한 포트번호로 인해 사용자를 구분 할 수 있다. (포트 개수는 제한되어있다.)

#### NAT/PAT의 용도와 필요성

1. IPv4주소 고갈문제의 솔루션으로 NAT가 사용된다.

   - NAT를 이용한 중기전략은 외부에 공개해야 하는 서비스에 대해서는 공인IP를 사용하고
     외부에 공개할 필요가 없는 일반 사용자의 PC나 기타 종단 장비는 사설IP를 사용해 꼭 필요한 곳에만 효율적으로 IP를 사용하게 한다.

2. 보안을 강화하는데 NAT기술을 사용한다.

   - 외부와 통신을 할때 내부IP를 다른IP로 변환해 외부로 통신하면 사내 IP주소를 숨길 수 있다.
   - NAT는 주소 변환후 역변환이 정상적으로 다시 수행되어야만 하기 때문에 복잡한 룰 설정 없이 방향성을 통제할 수 있다.

3. IP주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해준다.

   - IP대역이 같은 네트워크와 통신할 가능성이 높은 대외계 네트워크를 연결하기 위해 출발지와 도착지를 한꺼번에 변환하는 "더블 나트" 기술을 사용한다.

4. 불필요한 설정 변경을 줄일 수 있다.
   - NAT/PAT를 이용해 내부 네트워크를 구성하고 있었다면, IP를 이전해야하는 상황이 온다고 했을때 내부 서버나 PC 설정 변경을 최소화 할 수 있다.

#### NAT 동작 방식

- 출발지 사용자(10.10.10.10) 에서 목적지 웹서버(20.20.20.20)으로 통신하는 과정

1. 사용자는 웹서버로 출발지(10.10.10.10:2000), 목적지(20.20.20.20:80)으로 패킷을 전송한다. (출발지 포트는 임의의 포트로 할당. 여기선 2000)
2. NAT 장비는 사용자로부터 패킷을 전달 받고 NAT 정책에 따라 외부 네트워크와 통신이 가능한 공인IP(11.11.11.11)으로 IP를 변경한다.
   그리고 변경 전후 (전: 10.10.10.10, 후: 11.11.11.11) IP를 NAT 테이블에 저장한다.
3. NAT 장비는 출발지 주소를 11.11.11.11로 변경한 후 웹 서버로 전송한다.
4. 웹 서버는 패킷을 수신받고 사용자에게 응답을 보낸다. 응답일때는 요청과 반대로 출발지가 웹서버(20.20.20.20)이 되고 목적지는 NAT로 인해 변경된 공인IP(11.11.11.11)로 전송한다.
5. NAT는 웹 서버로 패킷을 전달 받고 NAT 테이블에서 변경 전후 를 확인한다.
6. NAT 테이블에서 변경된 공인IP(11.11.11.11)을 원래 패킷 출발지 IP(10.10.10.10)으로 변경하여 사용자에게 전송한다.

#### PAT 동작 방식

- 위의 NAT 예제와 같은 방식으로 진행

1. NAT와 마찬가지로 출발지와 목적지 IP가 있고 포트도 같다.
2. 외부 네트워크와 통신이 가능한 공인IP로 변경하고 다수의 사용자가 동일한 공인IP로 되어야하므로 패킷의 서비스 포트도 변경해준다. (2000 -> 3000)
   그 후, NAT테이블에 기록한다. (포트도 함께 기록)
3. 변경된 IP와 포트로 패킷을 재작성해 웹서버로 전송한다.
4. 웹서버는 사용자로 변환된 공인IP와 서비스 포트로 전송한다.
5. NAT는 웹서버로 패킷 수신하고 NAT 테이블에 원래 IP와 포트를 확인한다.
6. NAT는 원래 IP와 포트로 패킷을 재작성 한 후 사용자에게 전달한다.

#### SNAT와 DNAT

- SNAT(Souce NAT) - 출발지 주소를 변경하는 NAT
  - 사설에서 공인으로 통신할 때 사용한다.
  - NAT를 통해 출발지를 공인IP로 변경해 응답할 수 있는 경로를 찾는다.
  - 보안상 SNAT를 사용하여 외부에 통신할 때 내부의 IP를 공인IP로 변경해 내부IP를 숨길 수 있다.
  - 외부의 사내IP와 내부의 사내IP가 중복될 때 SNAT를 통해 중복도지 않는 다른 IP로 변경해 통신할 수 있다.
- DNAT(Destination NAT) - 도착지 주소를 변경하는 NAT
  - 로드 밸런서에서 많이 사용한다.
  - 사용자는 로드밸런서의 가상IP로 서비스를 요청하고 로드밸런서는 DNAT를 통해 로드밸런싱 될 리얼 서버IP로 보낸다.
  - 외부IP와 통신할때는 중복이 일어날 수 있다. 이때 DNAT를 이용하여 각각의 외부 IP를 변경하면 라우팅 이슈없이 통신할 수 있다.

#### 동적NAT와 정적NAT

- 정적NAT(1:1 NAT) - 출발지와 목적지의 IP를 미리 매핑해 고정해놓은 NAT를 정적NAT 라고 한다.
- 동적NAT - 출발지나 목적지 어느 경우든 사전에 정해지지 않고 NAT를 수행할 때 IP를 동적으로 변경하는것을 동적NAT라고 한다.
